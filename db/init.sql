CREATE TABLE IF NOT EXISTS commission (id CHAR(36) PRIMARY KEY, conversion_id CHAR(36) UNIQUE NOT NULL, affiliate_id VARCHAR(64) NOT NULL, campaign_id VARCHAR(64) NOT NULL, gross_amount DECIMAL(12,2) NOT NULL, gross_currency CHAR(3) NOT NULL, percentage DECIMAL(5,2) NOT NULL, net_amount DECIMAL(12,2) NOT NULL, net_currency CHAR(3) NOT NULL, status VARCHAR(16) NOT NULL, calculated_at TIMESTAMP NOT NULL, approved_at TIMESTAMP NULL);
CREATE TABLE IF NOT EXISTS commission_policy (id CHAR(36) PRIMARY KEY, name VARCHAR(128) NOT NULL, version INT NOT NULL, active_from TIMESTAMP NOT NULL, active_to TIMESTAMP NULL);
CREATE TABLE IF NOT EXISTS commission_rule (id CHAR(36) PRIMARY KEY, policy_id CHAR(36) NOT NULL, scope VARCHAR(16) NOT NULL, formula VARCHAR(16) NOT NULL, payload JSON NOT NULL);
CREATE TABLE IF NOT EXISTS outbox_event (id CHAR(36) PRIMARY KEY, aggregate_type VARCHAR(64) NOT NULL, aggregate_id CHAR(36) NOT NULL, event_type VARCHAR(64) NOT NULL, payload JSON NOT NULL, occurred_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP, published BOOLEAN NOT NULL DEFAULT FALSE);
INSERT INTO commission_policy (id,name,version,active_from,active_to) VALUES ('00000000-0000-0000-0000-000000000001','default',1,NOW(),NULL) ON DUPLICATE KEY UPDATE name=name;
INSERT INTO commission_rule (id,policy_id,scope,formula,payload) VALUES ('00000000-0000-0000-0000-000000000002','00000000-0000-0000-0000-000000000001','GLOBAL','PCT', JSON_OBJECT('percentage',12.5)) ON DUPLICATE KEY UPDATE scope=VALUES(scope);
